<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/messagesstyles.css') }}">
    <title>Chat with {{ friend.nick }}</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        
    </style>
</head>
<body class = "bg">
    <div class="navigation">
        <a href="{{ url_for('profile') }}">profil</a>
        <a href="{{ url_for('main') }}">g≈Ç√≥wna</a>
        <a href="ai.html">AI</a>
        <a href="{{ url_for('search') }}">wyszukaj urzytkownika</a>
        <a href="{{ url_for('private') }}">prywatne</a>
        <a href="{{ url_for('logout') }}">Wyloguj siƒô</a>
    </div>
    {% with messages = get_flashed_messages() %}
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-info flash-message">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const alerts = document.querySelectorAll('.alert');
            
            alerts.forEach(alert => {
                setTimeout(() => {
                    alert.classList.add('fade-out');
                    
                    alert.addEventListener('animationend', () => {
                        alert.remove();
                    });
                }, 5000);
            });
        });
    </script>

    
    <div id="overlaymessages" style="display: none;">
        <div id="editMessageForm" style="display: none;">
            <textarea id="editMessageContent"></textarea>
            <div id="existingMessageAttachments"></div>
            <div id="edit-drop-zone" class="drop-zone">
                <p>PrzeciƒÖgnij i upu≈õƒá pliki tutaj lub kliknij, aby wybraƒá</p>
                <input type="file" id="editMessageFiles" multiple style="display: none;">
            </div>
            <div id="editMessageAttachmentsPreview"></div>
            <button id="saveMessageEdit">Save</button>
            <button id="cancelMessageEdit">Cancel</button>
        </div>
    </div>
    <div class="content-wrapper">
        <div class="main-content">
            <div id="chat-messages" class="scrollable-chat">
                {% for message in messages %}
                    <div class="message-container {% if message.sender_id == current_user.id %}sent{% else %}received{% endif %}">
                        <div class="message-box" data-message-id="{{ message.id }}">
                            <a href="{{ url_for('user_profile', user_id=message.sender_id) }}" class="user-profile-link">
                                <div class="message-header">
                                    {% if message.sender.zdjecie_wskaznik == "basics/profile.png" %}
                                        <img src="{{ url_for('static', filename='basics/profile.png') }}" alt="Default profile picture" class="profile-picture">
                                    {% elif message.sender.zdjecie_wskaznik %}
                                        <img src="{{ url_for('static', filename='uploads/' + message.sender.zdjecie_wskaznik) }}" alt="{{ message.sender.nick }}'s profile picture" class="profile-picture">
                                    {% endif %}
                                    <strong class="author-name">{{ message.sender.nick }}</strong>
                                </div>
                            </a>
                            <span class="message-content">{{ message.message|nl2br|safe }}</span>
                            
                            {% if message.attachments %}
                            <div class="attachments">
                                <div style="opacity: 0;">
                                {% for attachment in message.attachments %}
                                    {% if attachment.file_type.startswith('image/') %}
                                        {% set image_path = 'uploads/' + attachment.file_name %}
                                        <img src="{{ url_for('static', filename=image_path) }}" alt="{{ attachment.file_name }}" data-id="{{ attachment.id }}">
                                    {% elif attachment.file_type.startswith('video/') %}
                                        {% set video_path = 'uploads/' + attachment.file_name %}
                                        <video controls data-id="{{ attachment.id }}">
                                            <source src="{{ url_for('static', filename=video_path) }}" type="{{ attachment.file_type }}">
                                        </video>
                                    {% elif attachment.file_type.startswith('audio/') %}
                                        {% set audio_path = 'uploads/' + attachment.file_name %}
                                        <audio controls data-id="{{ attachment.id }}">
                                            <source src="{{ url_for('static', filename=audio_path) }}" type="{{ attachment.file_type }}">
                                        </audio>
                                    {% else %}
                                        <p>
                                            <a href="{{ url_for('download_private_file', attachment_id=attachment.id) }}">Pobierz {{ attachment.original_filename }}</a> 
                                        </p>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            </div>
                            {% endif %}
                            {% if message.sender.nick != current_user.nick %}
                            <div class="reactions">
                                
                                {% for reaction in ['üëç', '‚ù§Ô∏è', 'üòÇ', 'üòÆ', 'üò¢'] %}
                                    <span class="reaction-btn" data-reaction="{{ reaction }}">{{ reaction }}</span>
                                {% endfor %}
                                
                            </div>
                            {% endif %}
                            <div class="active-reactions">
                                {% for reaction in message.reactions %}
                                    <span class="active-reaction">{{ reaction.reaction_type }}</span>
                                {% endfor %}
                            </div>
                            
                            {% if message.sender_id == current_user.id %}
                                <div class="message-actions">
                                    <button class="edit-btn">Edit</button>
                                    <button class="delete-btn">Delete</button>
                                </div>
                                <div id="overlaymessages" style="display: none;">
                                    <div id="editMessageForm" style="display: none;">
                                        <textarea id="editMessageContent"></textarea>
                                        <div id="existingMessageAttachments"></div>
                                        <input type="file" id="editMessageFiles" multiple>
                                        <div id="editMessageAttachmentsPreview"></div>
                                        <button id="saveMessageEdit">Save</button>
                                        <button id="cancelMessageEdit">Cancel</button>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                {% endfor %}
            </div>

            <div id="chat-form">
                <form id="message-form">
                    <input type="hidden" id="recipient-id" value="{{ friend.id }}">
                    <textarea id="message-input" name="message" rows="3" required></textarea>
                    <div id="drop-zone" class="drop-zone">
                        <p>PrzeciƒÖgnij i upu≈õƒá pliki tutaj lub kliknij, aby wybraƒá</p>
                        <input type="file" id="file-input" name="files" multiple>
                    </div>
                    <div id="attachments-preview"></div>
                    <button type="submit">Send</button>
                </form>
            </div>
            <div class="resize-handle" id="resize-handle"></div>
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    const resizeHandle = document.getElementById('resize-handle');
                    const mainContent = document.querySelector('.main-content');
                    const contentWrapper = document.querySelector('.content-wrapper');
                    let isResizing = false;
                
                    resizeHandle.addEventListener('mousedown', function(e) {
                        isResizing = true;
                        document.addEventListener('mousemove', resize);
                        document.addEventListener('mouseup', stopResize);
                        // Zapobieganie zaznaczaniu tekstu
                        document.body.style.userSelect = 'none';
                        document.body.style.webkitUserSelect = 'none';
                        document.body.style.msUserSelect = 'none';
                        e.preventDefault(); // Zapobiega domy≈õlnemu zachowaniu przeglƒÖdarki
                    });
                
                    function resize(e) {
                        if (!isResizing) return;
                        const containerWidth = contentWrapper.offsetWidth;
                        let newWidth = (e.clientX / containerWidth) * 100;
                        
                        // Ograniczenie szeroko≈õci do minimum 20% i maksimum 85%
                        newWidth = Math.max(20, Math.min(85, newWidth));
                        
                        mainContent.style.flex = `0 0 ${newWidth}%`;
                    }
                
                    function stopResize() {
                        isResizing = false;
                        document.removeEventListener('mousemove', resize);
                        document.removeEventListener('mouseup', stopResize);
                        // Przywr√≥cenie mo≈ºliwo≈õci zaznaczania tekstu
                        document.body.style.userSelect = '';
                        document.body.style.webkitUserSelect = '';
                        document.body.style.msUserSelect = '';
                    }
                });
                </script>
        </div>
        <div class="friend-info">
            <h1>Private Chat with {{ friend.nick }}</h1>
            <div id="friend-image-container">
                {% if friend.zdjecie_wskaznik == "basics/profile.png" %}
                <img class="friend-image" src="{{ url_for('static', filename='basics/profile.png') }}" alt="{{ friend.nick }}'s profile picture" data-version="{{ friend.zdjecie_version }}">
                {% else %}
                <img class="friend-image" src="{{ url_for('static', filename='uploads/' + friend.zdjecie_wskaznik) }}" alt="{{ friend.nick }}'s profile picture" data-version="{{ friend.zdjecie_version }}">
                {% endif %}
            </div>
            <h3>Friend Description:</h3>
            <p id="friend-description">{{ friend.opis }}</p>
        </div>
        <script>
            function fetchFriendInfo() {
                const friendId = {{ friend.id }};
                fetch(`/get_user_info/${friendId}`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    $('#friend-description').text(data.opis);
                    const friendImage = $('.friend-image');
                    const currentSrc = friendImage.attr('src');
                    let newSrc;
            
                    if (data.zdjecie_wskaznik != "basics/profile.png") {
                        newSrc = `{{ url_for('static', filename='uploads/') }}${data.zdjecie_wskaznik}?v=${data.zdjecie_version}`;
                        //console.log(data.zdjecie_wskaznik);
                    } else {
                        newSrc = "{{ url_for('static', filename='basics/profile.png') }}";
                    }
            
                    if (currentSrc !== newSrc) {
                        console.log("Updating friend image");
                        friendImage.attr('src', newSrc);
                        friendImage.attr('data-version', data.zdjecie_version);
                    }
            
                    $('h1').text(`Private Chat with ${data.nick}`);
                })
                .catch(error => console.error('Error fetching friend info:', error));
            }
            
            $(document).ready(function() {
                fetchFriendInfo();
                setInterval(fetchFriendInfo, 1000); 
            });
            </script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const messageForm = document.getElementById('message-form');
            const messageInput = document.getElementById('message-input');
            const fileInput = document.getElementById('file-input');
            const attachmentsPreview = document.getElementById('attachments-preview');
            const dropZone = document.getElementById('drop-zone');
        
            dropZone.addEventListener('click', function(e) {
                fileInput.click();
        });

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, unhighlight, false);
        });

        dropZone.addEventListener('drop', handleDrop, false);


        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function highlight(e) {
            dropZone.classList.add('highlight');
        }

        function unhighlight(e) {
            dropZone.classList.remove('highlight');
        }

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }

        function handleFiles(newFiles) {
            const dt = new DataTransfer();
            
            for (let file of fileInput.files) {
                dt.items.add(file);
            }
            
            for (let file of newFiles) {
                dt.items.add(file);
            }
            
            fileInput.files = dt.files;
            updateAttachmentPreviews();
        }

        fileInput.addEventListener('change', function(e) {
            updateAttachmentPreviews();
        });

        function updateAttachmentPreviews() {
            const currentFiles = Array.from(fileInput.files);
            const currentPreviews = Array.from(attachmentsPreview.children);
            
            currentPreviews.forEach(preview => {
                const fileName = preview.dataset.fileName;
                if (!currentFiles.some(file => file.name === fileName)) {
                    preview.remove();
                }
            });
            
            for (let file of currentFiles) {
                if (!currentPreviews.some(preview => preview.dataset.fileName === file.name)) {
                    const attachmentElement = createAttachmentElement({
                        type: file.type.startsWith('image/') ? 'img' : 
                              file.type.startsWith('video/') ? 'video' :
                              file.type.startsWith('audio/') ? 'audio' : 'file',
                        src: URL.createObjectURL(file),
                        file: file
                    });
                    attachmentElement.dataset.fileName = file.name;
                    attachmentsPreview.appendChild(attachmentElement);
                }
            }
        }
    
        function createAttachmentElement(attachment) {
            const attachmentDiv = document.createElement('div');
            attachmentDiv.className = 'attachment-preview';
            attachmentDiv.style.width = '100px';
            attachmentDiv.style.height = '100px';
            attachmentDiv.style.display = 'inline-block';
            attachmentDiv.style.margin = '5px';
            attachmentDiv.style.position = 'relative';
            attachmentDiv.style.border = '1px solid #ccc';
            attachmentDiv.style.borderRadius = '5px';
            attachmentDiv.style.overflow = 'hidden';
            attachmentDiv.dataset.fileName = attachment.file.name;
    
            let contentElement;
            if (attachment.type === 'img') {
                contentElement = document.createElement('img');
                contentElement.src = attachment.src;
                contentElement.style.width = '100%';
                contentElement.style.height = '100%';
                contentElement.style.objectFit = 'cover';
            } else {
                contentElement = document.createElement('div');
                contentElement.style.fontSize = '40px';
                contentElement.style.backgroundColor = 'transparent';
                contentElement.style.display = 'flex';
                contentElement.style.justifyContent = 'center';
                contentElement.style.alignItems = 'center';
                contentElement.style.width = '100%';
                contentElement.style.height = '100%';
    
                if (attachment.type === 'video') {
                    contentElement.textContent = 'üé•';
                } else if (attachment.type === 'audio') {
                    contentElement.textContent = 'üéµ';
                } else {
                    contentElement.textContent = 'üìé';
                }
            }
            attachmentDiv.appendChild(contentElement);
    
            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'X';
            deleteButton.style.position = 'absolute';
            deleteButton.style.top = '0';
            deleteButton.style.right = '0';
            deleteButton.style.background = 'red';
            deleteButton.style.color = 'white';
            deleteButton.style.border = 'none';
            deleteButton.style.cursor = 'pointer';
            deleteButton.onclick = (e) => {
                e.preventDefault();
                const dt = new DataTransfer();
                const files = fileInput.files;
                for (let i = 0; i < files.length; i++) {
                    if (files[i] !== attachment.file) {
                        dt.items.add(files[i]);
                    }
                }
                fileInput.files = dt.files;
                attachmentDiv.remove();
            };
            attachmentDiv.appendChild(deleteButton);
    
            return attachmentDiv;
        }

        let currentEditMessageId = null;

        messageForm.addEventListener('submit', function(e) {
            e.preventDefault();
            sendMessage();
        });

        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        function sendMessage() {
            const formData = new FormData();
            formData.append('message', messageInput.value.replace(/\n/g, '<br>')); 
            

            for (let file of fileInput.files) {
                formData.append('files', file);
            }

                const recipientId = document.getElementById('recipient-id').value;

                fetch(`/send_private_message/${recipientId}`, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    messageInput.value = '';
                    fileInput.value = '';
                    attachmentsPreview.innerHTML = '';
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                })
            }
        });

    </script>















    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const chatMessages = document.getElementById('chat-messages');
            const overlaymessages = document.getElementById('overlaymessages');
            const editMessageForm = document.getElementById('editMessageForm');
            const editMessageContent = document.getElementById('editMessageContent');
            const existingMessageAttachments = document.getElementById('existingMessageAttachments');
            const editDropZone = document.getElementById('edit-drop-zone');
            const editMessageFiles = document.getElementById('editMessageFiles');
            const editMessageAttachmentsPreview = document.getElementById('editMessageAttachmentsPreview');
            const saveMessageEdit = document.getElementById('saveMessageEdit');
            const cancelMessageEdit = document.getElementById('cancelMessageEdit');
        

            console.log('DOM elements:', {
                chatMessages,
                overlaymessages,
                editMessageForm,
                editMessageContent,
                existingMessageAttachments,
                editDropZone,
                editMessageFiles,
                editMessageAttachmentsPreview,
                saveMessageEdit,
                cancelMessageEdit
            });


            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
        
            function highlight(e) {
                editDropZone.classList.add('highlight');
            }
        
            function unhighlight(e) {
                editDropZone.classList.remove('highlight');
            }
        
            function handleEditDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                handleEditFiles(files);
            }
        
            function handleEditFiles(files) {
                [...files].forEach(file => {
                    if ([...editMessageFiles.files].every(f => f.name !== file.name)) {
                        const dataTransfer = new DataTransfer();
                        [...editMessageFiles.files].forEach(f => dataTransfer.items.add(f));
                        dataTransfer.items.add(file);
                        editMessageFiles.files = dataTransfer.files;
                        const attachment = {
                            type: file.type.startsWith('image/') ? 'img' : 
                                  file.type.startsWith('video/') ? 'video' :
                                  file.type.startsWith('audio/') ? 'audio' : 'file',
                            src: URL.createObjectURL(file),
                            file: file
                        };
                        const attachmentElement = createAttachmentElement(attachment);
                        editMessageAttachmentsPreview.appendChild(attachmentElement);
                    }
                });
            }
            function uploadEditFile(file) {
                handleEditFiles([file]);
            }
        
            editDropZone.addEventListener('click', function(e) {
                    editMessageFiles.click();
            });
        
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                editDropZone.addEventListener(eventName, preventDefaults, false);
            });
        
            ['dragenter', 'dragover'].forEach(eventName => {
                editDropZone.addEventListener(eventName, highlight, false);
            });
        
            ['dragleave', 'drop'].forEach(eventName => {
                editDropZone.addEventListener(eventName, unhighlight, false);
            });
        
            editDropZone.addEventListener('drop', handleEditDrop, false);
        
            editMessageFiles.addEventListener('change', function(e) {
                handleEditFiles(this.files);
            });
        

            let currentEditMessageId = null;
            let currentAttachments = [];
            function processMessageContent(content) {
                return content.replace(/\n/g, '<br>');
            }
             function showEditForm(messageId, content, attachments) {
                currentEditMessageId = messageId;
                editMessageContent.value = content;
                existingMessageAttachments.innerHTML = '';
                editMessageAttachmentsPreview.innerHTML = '';
                attachments.forEach(attachment => {
                    const attachmentElement = createAttachmentElement(attachment);
                    existingMessageAttachments.appendChild(attachmentElement);
                });
        const messageBox = document.querySelector(`.message-box[data-message-id="${messageId}"]`);
        console.log('MessageBox:', messageBox);
        if (messageBox) {
            const rect = messageBox.getBoundingClientRect();
            console.log('MessageBox rect:', rect);
            overlaymessages.style.display = 'block';
            editMessageForm.style.display = 'block';
            editMessageForm.style.position = 'fixed';
            editMessageForm.style.top = `${rect.top}px`;
            editMessageForm.style.left = `${rect.left}px`;
            editMessageForm.style.maxWidth = `${rect.width}px`;
            editMessageForm.style.zIndex = '1000';
            overlaymessages.style.position = 'fixed';
            overlaymessages.style.top = '0';
            overlaymessages.style.left = '0';
            overlaymessages.style.width = '100%';
            overlaymessages.style.height = '100%';
            overlaymessages.style.zIndex = '999';
            console.log('Styles applied:', {
                overlaymessages: overlaymessages.style,
                editMessageForm: editMessageForm.style
            });
        } else {
            console.error(`Message box with id ${messageId} not found`);
        }
    }

            function hideEditForm() {
                overlaymessages.style.display = 'none';
                editMessageForm.style.display = 'none';
                currentEditMessageId = null;
                clearEditForm();
            }

            function clearEditForm() {
                editMessageContent.value = '';
                editMessageFiles.value = ''; 
                existingMessageAttachments.innerHTML = '';
                editMessageAttachmentsPreview.innerHTML = '';
                currentAttachments = [];
            }

            function createAttachmentElement(attachment) {
                console.log('Attachment ' + attachment.id );
                const attachmentDiv = document.createElement('div');
                attachmentDiv.className = 'attachment-preview';
                attachmentDiv.style.width = '100px';
                attachmentDiv.style.height = '100px';
                attachmentDiv.style.display = 'inline-block';
                attachmentDiv.style.margin = '5px';
                attachmentDiv.style.position = 'relative';
                attachmentDiv.style.border = '1px solid #ccc';
                attachmentDiv.style.borderRadius = '5px';
                attachmentDiv.style.overflow = 'hidden';


                let contentElement;
                if (attachment.type === 'img') {
                    contentElement = document.createElement('img');
                    contentElement.src = attachment.src;
                    contentElement.style.width = '100%';
                    contentElement.style.height = '100%';
                    contentElement.style.objectFit = 'cover';
                } else {
                    const link = document.createElement('a');
                    link.href = attachment.src;
                    link.target = '_blank';

                    contentElement = document.createElement('div');
                    contentElement.style.fontSize = '40px';
                    contentElement.style.backgroundColor = 'transparent';
                    contentElement.style.display = 'flex';
                    contentElement.style.justifyContent = 'center';
                    contentElement.style.alignItems = 'center';
                    contentElement.style.width = '100%';
                    contentElement.style.height = '100%';

                    if (attachment.type === 'video') {
                        contentElement.textContent = 'üé•';
                    } else if (attachment.type === 'audio') {
                        contentElement.textContent = 'üéµ';
                    } else {
                        contentElement.textContent = 'üìé';
                    }

                    link.appendChild(contentElement);
                    contentElement = link;
                }

                attachmentDiv.appendChild(contentElement);

                if (attachment.id) {
                    contentElement.dataset.id = attachment.id;
                } 
                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'X';
                deleteButton.style.position = 'absolute';
                deleteButton.style.top = '0';
                deleteButton.style.right = '0';
                deleteButton.style.background = 'red';
                deleteButton.style.color = 'white';
                deleteButton.style.border = 'none';
                deleteButton.style.cursor = 'pointer';
                deleteButton.onclick = (e) => {
                    e.preventDefault();
                    if (attachment.id) {
                        attachment.toDelete = true;
                    } else {
                        const dt = new DataTransfer();
                        const files = editMessageFiles.files;
                        for (let i = 0; i < files.length; i++) {
                            if (files[i] !== attachment.file) {
                                dt.items.add(files[i]);
                            }
                        }
                        editMessageFiles.files = dt.files;
                    }
                    attachmentDiv.remove();
                };
                attachmentDiv.appendChild(deleteButton);
                return attachmentDiv;
            }


                
            document.addEventListener('click', function(e) {
                if (e.target.closest('.edit-btn')) {
                    const messageBox = e.target.closest('.message-box');
                    const messageId = messageBox.dataset.messageId;
                    const contentElement = messageBox.querySelector('.message-content');
                    const content = contentElement.innerHTML.replace(/<br\s*\/?>/g, '\n').trim();
                    console.log('Content:', content);
                    
                    const attachments = Array.from(messageBox.querySelectorAll('[data-id]')).map(el => ({
                        id: el.dataset.id,
                        type: el.tagName.toLowerCase(),
                        src: el.src || el.href
                    }));
                    
                    console.log('Editing message:', { messageId, content, attachments });
                    showEditForm(messageId, content, attachments);
                }
            });


        
            function saveEditedMessage() {
                const formData = new FormData();
                const contentForSaving = processMessageContent(editMessageContent.value);
                formData.append('message', contentForSaving);
                formData.append('message_id', currentEditMessageId);
                const editedContent = processMessageContent(editMessageContent.value);
                const existingAttachments = existingMessageAttachments.querySelectorAll('.attachment-preview');
                existingAttachments.forEach(attachment => {
                    const attachmentId = attachment.querySelector('img, video, audio, a').dataset.id;
                    formData.append('existing_attachments[]', attachmentId);
                });

                for (let file of editMessageFiles.files) {
                    formData.append('new_files[]', file);
                }
                //console.log("Existing attachments:", Array.from(formData.getAll('existing_attachments[]')));
                //console.log("New files:", Array.from(formData.getAll('new_files[]')));
                
                fetch(`/edit_private_message/${currentEditMessageId}`, {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === "OK") {
                        const messageBox = document.querySelector(`.message-box[data-message-id="${currentEditMessageId}"]`);
                        messageBox.querySelector('.message-content').textContent = editMessageContent.value;
                        
                        let attachmentsContainer = messageBox.querySelector('.attachments');
                        
                        if (!attachmentsContainer) {
                            attachmentsContainer = document.createElement('div');
                            attachmentsContainer.className = 'attachments';
                            messageBox.appendChild(attachmentsContainer);
                        } else {
                            attachmentsContainer.innerHTML = '';
                        }

                        if (data.attachments && data.attachments.length > 0) {
                            data.attachments.forEach(attachment => {
                                const attachmentElement = createAttachmentElement(attachment);
                                attachmentsContainer.appendChild(attachmentElement);
                            });
                        }
                
                        hideEditForm();
                    }
                });
            }
        
            saveMessageEdit.addEventListener('click', saveEditedMessage);

            editMessageContent.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    saveEditedMessage();
                }
            });
        
            cancelMessageEdit.addEventListener('click', hideEditForm);
        
        
            editMessageFiles.addEventListener('change', function(e) {
                editMessageAttachmentsPreview.innerHTML = '';
                for (let file of e.target.files) {
                    const attachmentDiv = createAttachmentElement({
                        type: file.type.startsWith('image/') ? 'img' : 
                              file.type.startsWith('video/') ? 'video' :
                              file.type.startsWith('audio/') ? 'audio' : 'file',
                        src: URL.createObjectURL(file),
                        file: file 
                    });
                    editMessageAttachmentsPreview.appendChild(attachmentDiv);
                }
            });
        });
        </script>
    

















    <script>
        const chatMessages = document.getElementById('chat-messages');
        $(document).ready(function() {
            let lastCheck = new Date().toISOString();
            const friendId = {{ friend.id }};

            $(document).on('click', '.message-box', function(e) {
                if (!$(e.target).closest('.message-actions, .edit-form').length) {
                    $(this).find('.reactions').toggle();
                }
            });

            $(document).on('click', '.reaction-btn', function() {
                const messageBox = $(this).closest('.message-box');
                const messageId = messageBox.data('message-id');
                const reactionType = $(this).data('reaction');
        
                $.ajax({
                    url: '/react_to_message',
                    method: 'POST',
                    data: {
                        message_id: messageId,
                        reaction_type: reactionType
                    },
                    success: function(response) {
                        if (response.status === 'success') {
                            console.log('Reakcja zaktualizowana');
                            updateReactionUI(messageBox, response.reactions);
                        } else {
                            console.error('B≈ÇƒÖd podczas aktualizacji reakcji:', response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('B≈ÇƒÖd AJAX:', error);
                    }
                });
            });


            function updateReactionUI(messageBox, reactions) {
                const activeReactions = messageBox.find('.active-reactions');
                activeReactions.empty();
            
                if (reactions && typeof reactions === 'object') {
                    for (const [reaction, count] of Object.entries(reactions)) {
                        if (reaction !== 'user_reaction' && count > 0) {
                            activeReactions.append(`<span class="active-reaction">${reaction} ${count}</span>`);
                        }
                    }
            
                    messageBox.find('.reaction-btn').removeClass('user-reacted');
                    if (reactions.user_reaction) {
                        messageBox.find(`.reaction-btn[data-reaction="${reactions.user_reaction}"]`).addClass('user-reacted');
                    }
                }
            }
            function updateAttachments(messageBox, attachments) {
                let attachmentsContainer = messageBox.find('.attachments');
                if (attachmentsContainer.length === 0) {
                    attachmentsContainer = $('<div class="attachments"></div>');
                    messageBox.append(attachmentsContainer);
                }
                attachmentsContainer.empty();
            
                if (attachments && attachments.length > 0) {
                    attachments.forEach(attachment => {
                        if (attachment.file_type.startsWith('image/')) {
                            const img = $('<img>', {
                                src: `/static/uploads/${attachment.file_name}`,
                                alt: attachment.original_filename
                            });
                            attachmentsContainer.append(img);
                        } else if (attachment.file_type.startsWith('video/')) {
                            const video = $('<video controls>');
                            const source = $('<source>', {
                                src: `/static/uploads/${attachment.file_name}`,
                                type: attachment.file_type
                            });
                            video.append(source);
                            attachmentsContainer.append(video);
                        } else if (attachment.file_type.startsWith('audio/')) {
                            const audio = $('<audio controls>');
                            const source = $('<source>', {
                                src: `/static/uploads/${attachment.file_name}`,
                                type: attachment.file_type
                            });
                            audio.append(source);
                            attachmentsContainer.append(audio);
                        } else {
                            const link = $('<a>', {
                                href: `/download_private_file/${attachment.id}`,
                                text: `Pobierz ${attachment.original_filename}`
                            });
                            attachmentsContainer.append(link);
                        }
                    });
                }
            }
            function processMessageContent(content) {
                return content.replace(/&lt;br&gt;/g, '<br>');
            }
            function displayMessage(message) {
                const messageClass = message.sender_id == {{ current_user.id }} ? 'sent' : 'received';
                const senderNick = message.sender_id == {{ current_user.id }} ? '{{ current_user.nick }}' : '{{ friend.nick }}';
                const isCurrentUser = message.sender_id == {{ current_user.id }};

                let messageHtml = `
                <div class="message-container ${messageClass}">
                    <div class="message-box" data-message-id="${message.id}" data-user-id="${message.sender_id}" data-user-nick="${message.sender_nick}" data-user-zdjecie-version="${message.sender_zdjecie_wskaznik}">
                        <div class="message-header">
                            <a href="/user/${message.sender_id}" class="user-profile-link">
                                <img src="${message.sender_zdjecie_wskaznik === 'basics/profile.png' ? 
                                '/static/basics/profile.png' : 
                                '/static/uploads/' + message.sender_zdjecie_wskaznik}" 
                                    alt="${senderNick}" class="profile-picture">
                                <strong class="author-name">${senderNick}</strong>
                            </a>
                        </div>
                        <span class="message-content">${processMessageContent(message.message)}</span>
                        <div class="attachments"></div>
                        ${!isCurrentUser ? `
                        <div class="reactions">
                            <span class="reaction-btn" data-reaction="üëç">üëç</span>
                            <span class="reaction-btn" data-reaction="‚ù§Ô∏è">‚ù§Ô∏è</span>
                            <span class="reaction-btn" data-reaction="üòÇ">üòÇ</span>
                            <span class="reaction-btn" data-reaction="üòÆ">üòÆ</span>
                            <span class="reaction-btn" data-reaction="üò¢">üò¢</span>
                        </div>
                        ` : ''}
                        <div class="active-reactions"></div>
                    </div>
                </div>
            `;

                    
                    const $messageElement = $(messageHtml);
                    $('#chat-messages').append($messageElement);
                
                    updateAttachments($messageElement.find('.message-box'), message.attachments);
                
                    if (isCurrentUser) {
                        const actionsHtml = `
                            <div class="message-actions">
                                <button class="edit-btn" data-action="edit-btn" data-message-id="${message.id}">Edit</button>
                                <button class="delete-btn" data-action="delete" data-message-id="${message.id}">Delete</button>
                            </div>
                        `;
                        $messageElement.find('.message-box').append(actionsHtml);
                    } 
                
                    updateReactionUI($messageElement.find('.message-box'), message.reactions);
                }

                function updateAttachments(messageBox, attachments) {
                    let attachmentsContainer = messageBox.find('.attachments');
                    if (attachmentsContainer.length === 0) {
                        attachmentsContainer = $('<div class="attachments"></div>');
                        messageBox.append(attachmentsContainer);
                    }
                    attachmentsContainer.empty();

                    if (attachments && attachments.length > 0) {
                        attachments.forEach(attachment => {
                            let attachmentHtml = '';
                            const attachmentId = attachment.id || '';
                            if (attachment.file_type.startsWith('image/')) {
                                attachmentHtml = `<img src="/static/uploads/${attachment.file_name}" alt="${attachment.original_filename}" data-id="${attachmentId}">`;
                            } else if (attachment.file_type.startsWith('video/')) {
                                attachmentHtml = `
                                    <video controls data-id="${attachmentId}">
                                        <source src="/static/uploads/${attachment.file_name}" type="${attachment.file_type}">
                                    </video>
                                `;
                            } else if (attachment.file_type.startsWith('audio/')) {
                                attachmentHtml = `
                                    <audio controls data-id="${attachmentId}">
                                        <source src="/static/uploads/${attachment.file_name}" type="${attachment.file_type}">
                                    </audio>
                                `;
                            } else {
                                attachmentHtml = `
                                    <p data-id="${attachmentId}">
                                        <a href="/download_private_file/${attachmentId}">Pobierz ${attachment.original_filename}</a>
                                    </p>
                                `;
                            }
                            attachmentsContainer.append(attachmentHtml);
                        });
                    }
                }


            

                function fetchNewMessages() {
                    fetch(`/get_new_messages/${friendId}`)
                        .then(response => response.json())
                        .then(messages => {
                            const receivedMessageIds = messages.map(message => message.id);
                            
                            $('.message-container').each(function() {
                                const messageId = $(this).find('.message-box').data('message-id');
                                if (!receivedMessageIds.includes(messageId)) {
                                    $(this).remove();
                                }
                            });
                
                            messages.forEach(message => {
                                const existingMessage = $(`.message-box[data-message-id="${message.id}"]`);
                                if (existingMessage.length) {
                                    updateExistingMessage(existingMessage, message);
                                } else {
                                    displayMessage(message);
                                }
                
                                const existingProfileInMessage = $(`.message-box[data-message-id="${message.id}"]`);
                                const currentNick = existingProfileInMessage.attr('data-user-nick');
                                const currentZdjecieVersion = existingProfileInMessage.attr('data-user-zdjecie-version');
                
                                const isNickChanged = currentNick !== message.sender_nick;
                                const isImageChanged = currentZdjecieVersion !== message.sender_zdjecie_version;
                
                                if (isNickChanged) {
                                    existingProfileInMessage.attr('data-user-nick', message.sender_nick);
                                    existingProfileInMessage.find('.author-name').text(message.sender_nick);
                                }
                
                                if (isImageChanged) {
                                    existingProfileInMessage.attr('data-user-zdjecie-version', message.sender_zdjecie_version);
                                    const newImageSrc = message.sender_zdjecie_wskaznik === 'basics/profile.png' ?
                                        '/static/basics/profile.png' :
                                        `/static/uploads/${message.sender_zdjecie_wskaznik}`;
                                    existingProfileInMessage.find('.profile-picture').attr('src', newImageSrc);
                                }
                            });
                
                            if (messages.length > 0) {
                                lastCheck = messages[messages.length - 1].created_at;
                            }
                        })
                        .catch(error => console.error('Error fetching messages:', error));
                }
    

            
            function updateExistingMessage(existingMessage, updatedMessage) {
                const processedMessage = processMessageContent(updatedMessage.message);
                if (existingMessage.find('.message-content').html() !== processedMessage) {
                    existingMessage.find('.message-content').html(processedMessage);
                }
                if (existingMessage.reactions != updatedMessage.reactions) {
                    updateReactionUI(existingMessage, updatedMessage.reactions);
                }
            
                const existingAttachments = existingMessage.find('.attachments').children().map(function() {
                    return $(this).data('id');
                }).get();
            
                const updatedAttachmentIds = updatedMessage.attachments.map(attachment => attachment.id ? attachment.id.toString() : '');
            
                //console.log("Existing attachment IDs:", existingAttachments);
                //console.log("Updated attachment IDs:", updatedAttachmentIds);
            
                let attachmentsChanged = false;
            
                if (existingAttachments.length !== updatedAttachmentIds.length) {
                    attachmentsChanged = true;
                } else {
                    attachmentsChanged = !existingAttachments.every((id, index) => {
                        const existingId = id ? id.toString() : '';
                        const updatedId = updatedAttachmentIds[index] ? updatedAttachmentIds[index].toString() : '';
                        return existingId === updatedId || 
                               (existingId.startsWith && existingId.startsWith('temp_id_') && updatedId === '');
                    });
                }
            
                if (attachmentsChanged) {
                    //console.log("Attachments have changed.");
                    updateAttachments(existingMessage, updatedMessage.attachments);
                } else {
                    //console.log("Attachments have not changed");
                }
            }

            $(document).on('click', '.delete-btn', function() {
                const messageBox = $(this).closest('.message-box');
                const messageId = messageBox.data('message-id');
                if (confirm('Are you sure you want to delete this message?')) {
                    deleteMessage(messageId);
                }
            });
            function deleteMessage(messageId) {
                    $.ajax({
                        url: '/delete_private_message',
                        method: 'POST',
                        data: { message_id: messageId },
                        success: function(response) {
                            if (response.status === 'success') {
                                messageBox.closest('.message-container').fadeOut(200, function() {
                                    $(this).remove();
                                });
                            } else {
                                alert('Failed to delete message: ' + response.message);
                            }
                        },
                        error: function() {
                            alert('An error occurred while trying to delete the message.');
                        }
                    });
                }

    
            setInterval(fetchNewMessages, 50);
        });
    </script>
</body>
</html>
