<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/messagesstyles.css') }}">
    <title>Chat with {{ friend.nick }}</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        
    </style>
</head>
<body>
    <div class="navigation">
        <a href="{{ url_for('profile') }}">profil</a>
        <a href="{{ url_for('main') }}">g贸wna</a>
        <a href="ai.html">AI</a>
        <a href="{{ url_for('search') }}">wyszukaj urzytkownika</a>
        <a href="{{ url_for('private') }}">prywatne</a>
        <a href="{{ url_for('logout') }}">Wyloguj si</a>
    </div>

    <h1>Private Chat with {{ friend.nick }}</h1>

    <div id="chat-messages">
        {% for message in messages %}
            <div class="message-container {% if message.sender_id == current_user.id %}sent{% else %}received{% endif %}">
                <div class="message-box" data-message-id="{{ message.id }}">
                    <strong>{{ message.sender.nick }}:</strong> 
                    <span class="message-content">{{ message.message }}</span>
                    {% if message.attachments %}
                    <div class="attachments">
                        <div style="opacity: 0;">
                        {% for attachment in message.attachments %}
                            {% if attachment.file_type.startswith('image/') %}
                                {% set image_path = 'uploads/' + attachment.file_name %}
                                <img src="{{ url_for('static', filename=image_path) }}" alt="{{ attachment.file_name }}" data-id="{{ attachment.id }}">
                            {% elif attachment.file_type.startswith('video/') %}
                                {% set video_path = 'uploads/' + attachment.file_name %}
                                <video controls data-id="{{ attachment.id }}">
                                    <source src="{{ url_for('static', filename=video_path) }}" type="{{ attachment.file_type }}">
                                </video>
                            {% elif attachment.file_type.startswith('audio/') %}
                                {% set audio_path = 'uploads/' + attachment.file_name %}
                                <audio controls data-id="{{ attachment.id }}">
                                    <source src="{{ url_for('static', filename=audio_path) }}" type="{{ attachment.file_type }}">
                                </audio>
                            {% else %}
                                <p>
                                    <a href="{{ url_for('download_private_file', attachment_id=attachment.id) }}">Pobierz {{ attachment.original_filename }}</a> 
                                </p>
                            {% endif %}
                        {% endfor %}
                    </div>
                    </div>
                    {% endif %}
                    {% if message.sender.nick != current_user.nick %}
                    <div class="reactions">
                        
                        {% for reaction in ['', 'わ', '', '', ''] %}
                            <span class="reaction-btn" data-reaction="{{ reaction }}">{{ reaction }}</span>
                        {% endfor %}
                        
                    </div>
                    {% endif %}
                    <div class="active-reactions">
                        {% for reaction in message.reactions %}
                            <span class="active-reaction">{{ reaction.reaction_type }}</span>
                        {% endfor %}
                    </div>
                    
                    {% if message.sender_id == current_user.id %}
                        <div class="message-actions">
                            <button class="edit-btn">Edit</button>
                            <button class="delete-btn">Delete</button>
                        </div>
                        <div id="overlaymessages" style="display: none;">
                            <div id="editMessageForm" style="display: none;">
                                <textarea id="editMessageContent"></textarea>
                                <div id="existingMessageAttachments"></div>
                                <input type="file" id="editMessageFiles" multiple>
                                <div id="editMessageAttachmentsPreview"></div>
                                <button id="saveMessageEdit">Save</button>
                                <button id="cancelMessageEdit">Cancel</button>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>

        {% endfor %}
    </div>

    <div id="chat-form">
        <form id="message-form">
            <input type="hidden" id="recipient-id" value="{{ friend.id }}">
            <textarea id="message-input" name="message" rows="3" required></textarea>
            <input type="file" id="file-input" name="files" multiple>
            <div id="attachments-preview"></div>
            <button type="submit">Send</button>
        </form>

    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const messageForm = document.getElementById('message-form');
            const messageInput = document.getElementById('message-input');
            const fileInput = document.getElementById('file-input');
            const attachmentsPreview = document.getElementById('attachments-preview');
            const chatMessages = document.getElementById('chat-messages');
            const editOverlay = document.getElementById('edit-message-overlay');
            const editForm = document.getElementById('edit-message-form');
            const editInput = document.getElementById('edit-message-input');
            const editFileInput = document.getElementById('edit-file-input');
            const editAttachmentsPreview = document.getElementById('edit-attachments-preview');
            const saveEditBtn = document.getElementById('save-edit');
            const cancelEditBtn = document.getElementById('cancel-edit');
        
            let currentEditMessageId = null;

            messageForm.addEventListener('submit', function(e) {
                e.preventDefault();

                const formData = new FormData();
                formData.append('message', messageInput.value);

                for (let file of fileInput.files) {
                    formData.append('files', file);
                }

                const recipientId = document.getElementById('recipient-id').value;

                fetch(`/send_private_message/${recipientId}`, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === "OK") {
                        messageInput.value = '';
                        fileInput.value = '';
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    } else {
                        alert('Error sending message: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while sending the message.');
                });
            });


        });

    </script>

    

    <script>
        $(document).ready(function() {
            let lastCheck = new Date().toISOString();
            const friendId = {{ friend.id }};

            $(document).on('click', '.message-box', function(e) {
                if (!$(e.target).closest('.message-actions, .edit-form').length) {
                    $(this).find('.reactions').toggle();
                }
            });

            $(document).on('click', '.reaction-btn', function() {
                const messageBox = $(this).closest('.message-box');
                const messageId = messageBox.data('message-id');
                const reactionType = $(this).data('reaction');
        
                $.ajax({
                    url: '/react_to_message',
                    method: 'POST',
                    data: {
                        message_id: messageId,
                        reaction_type: reactionType
                    },
                    success: function(response) {
                        if (response.status === 'success') {
                            console.log('Reakcja zaktualizowana');
                            updateReactionUI(messageBox, response.reactions);
                        } else {
                            console.error('Bd podczas aktualizacji reakcji:', response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Bd AJAX:', error);
                    }
                });
            });


            function updateReactionUI(messageBox, reactions) {
                const activeReactions = messageBox.find('.active-reactions');
                activeReactions.empty();
            
                if (reactions && typeof reactions === 'object') {
                    for (const [reaction, count] of Object.entries(reactions)) {
                        if (reaction !== 'user_reaction' && count > 0) {
                            activeReactions.append(`<span class="active-reaction">${reaction} ${count}</span>`);
                        }
                    }
            
                    messageBox.find('.reaction-btn').removeClass('user-reacted');
                    if (reactions.user_reaction) {
                        messageBox.find(`.reaction-btn[data-reaction="${reactions.user_reaction}"]`).addClass('user-reacted');
                    }
                }
            }
            function updateAttachments(messageBox, attachments) {
                let attachmentsContainer = messageBox.find('.attachments');
                if (attachmentsContainer.length === 0) {
                    attachmentsContainer = $('<div class="attachments"></div>');
                    messageBox.append(attachmentsContainer);
                }
                attachmentsContainer.empty();
            
                if (attachments && attachments.length > 0) {
                    attachments.forEach(attachment => {
                        if (attachment.file_type.startsWith('image/')) {
                            const img = $('<img>', {
                                src: `/static/uploads/${attachment.file_name}`,
                                alt: attachment.original_filename
                            });
                            attachmentsContainer.append(img);
                        } else if (attachment.file_type.startsWith('video/')) {
                            const video = $('<video controls>');
                            const source = $('<source>', {
                                src: `/static/uploads/${attachment.file_name}`,
                                type: attachment.file_type
                            });
                            video.append(source);
                            attachmentsContainer.append(video);
                        } else if (attachment.file_type.startsWith('audio/')) {
                            const audio = $('<audio controls>');
                            const source = $('<source>', {
                                src: `/static/uploads/${attachment.file_name}`,
                                type: attachment.file_type
                            });
                            audio.append(source);
                            attachmentsContainer.append(audio);
                        } else {
                            const link = $('<a>', {
                                href: `/download_private_file/${attachment.id}`,
                                text: `Pobierz ${attachment.original_filename}`
                            });
                            attachmentsContainer.append(link);
                        }
                    });
                }
            }
            
            function displayMessage(message) {
                const messageClass = message.sender_id == {{ current_user.id }} ? 'sent' : 'received';
                const senderNick = message.sender_id == {{ current_user.id }} ? '{{ current_user.nick }}' : '{{ friend.nick }}';
                let messageHtml = `
                    <div class="message-container ${messageClass}">
                        <div class="message-box" data-message-id="${message.id}">
                            <strong>${senderNick}:</strong> 
                            <span class="message-content">${message.message}</span>
                            <div class="reactions">
                                <span class="reaction-btn" data-reaction=""></span>
                                <span class="reaction-btn" data-reaction="わ">わ</span>
                                <span class="reaction-btn" data-reaction=""></span>
                                <span class="reaction-btn" data-reaction=""></span>
                                <span class="reaction-btn" data-reaction=""></span>
                            </div>
                            <div class="active-reactions"></div>
                            <div class="attachments"></div>
                        </div>
                    </div>
                `;
                
                const $messageElement = $(messageHtml);
                $('#chat-messages').append($messageElement);

                if (message.sender_id == {{ current_user.id }}) {
                    const actionsHtml = `
                        <div class="message-actions">
                            <button class="edit-btn">Edit</button>
                            <button class="delete-btn">Delete</button>
                        </div>
                        <form class="edit-form" style="display: none;">
                            <textarea name="new_content">${message.message}</textarea>
                            <button type="submit">Save</button>
                            <button type="button" class="cancel-edit">Cancel</button>
                        </form>
                    `;
                    $messageElement.find('.message-box').append(actionsHtml);
                }}

                function updateAttachments(messageBox, attachments) {
                    let attachmentsContainer = messageBox.find('.attachments');
                    if (attachmentsContainer.length === 0) {
                        attachmentsContainer = $('<div class="attachments"></div>');
                        messageBox.append(attachmentsContainer);
                    }
                    attachmentsContainer.empty();

                    if (attachments && attachments.length > 0) {
                        attachments.forEach(attachment => {
                            let attachmentHtml = '';
                            const attachmentId = attachment.id || '';
                            if (attachment.file_type.startsWith('image/')) {
                                attachmentHtml = `<img src="/static/uploads/${attachment.file_name}" alt="${attachment.original_filename}" data-id="${attachmentId}">`;
                            } else if (attachment.file_type.startsWith('video/')) {
                                attachmentHtml = `
                                    <video controls data-id="${attachmentId}">
                                        <source src="/static/uploads/${attachment.file_name}" type="${attachment.file_type}">
                                    </video>
                                `;
                            } else if (attachment.file_type.startsWith('audio/')) {
                                attachmentHtml = `
                                    <audio controls data-id="${attachmentId}">
                                        <source src="/static/uploads/${attachment.file_name}" type="${attachment.file_type}">
                                    </audio>
                                `;
                            } else {
                                attachmentHtml = `
                                    <p data-id="${attachmentId}">
                                        <a href="/download_private_file/${attachmentId}">Pobierz ${attachment.original_filename}</a>
                                    </p>
                                `;
                            }
                            attachmentsContainer.append(attachmentHtml);
                        });
                    }
                }


            

            function fetchNewMessages() {
                console.log("Fetching new messages since:", lastCheck);
                fetch(`/get_new_messages/${friendId}`)
                    .then(response => response.json())
                    .then(messages => {
                        console.log("Received messages:", messages);
                        messages.forEach(message => {
                            //console.log(message.id)
                            const existingMessage = $(`.message-box[data-message-id="${message.id}"]`);
                            if (existingMessage.length) {
                                updateExistingMessage(existingMessage, message);
                            } else {
                                displayMessage(message);
                            }
                        });
                        if (messages.length > 0) {
                            lastCheck = messages[messages.length - 1].created_at;
                            console.log("Updated lastCheck to:", lastCheck);
                        }
                    })
                    .catch(error => console.error('Error fetching messages:', error));
            }
            
            function updateExistingMessage(existingMessage, updatedMessage) {
                if (existingMessage.find('.message-content').text() !== updatedMessage.message) {
                    existingMessage.find('.message-content').text(updatedMessage.message);
                }
                if (existingMessage.reactions != updatedMessage.reactions) {
                    updateReactionUI(existingMessage, updatedMessage.reactions);
                }

                const existingAttachments = existingMessage.find('.attachments').children().map(function() {
                    return $(this).data('id');
                }).get();

                const updatedAttachmentIds = updatedMessage.attachments.map(attachment => attachment.id || '');

                //console.log("Existing attachment IDs:", existingAttachments);
                //console.log("Updated attachment IDs:", updatedAttachmentIds);

                let attachmentsChanged = false;

                // Sprawd藕, czy liczba zacznik贸w si zmienia
                if (existingAttachments.length !== updatedAttachmentIds.length) {
                    attachmentsChanged = true;
                } else {
                    // Por贸wnaj identyfikatory zacznik贸w
                    attachmentsChanged = !existingAttachments.every((id, index) => {
                        return id === updatedAttachmentIds[index] || 
                               (id.startsWith('temp_id_') && updatedAttachmentIds[index] === '');
                    });
                }

                if (attachmentsChanged) {
                    console.log("Attachments have changed.");
                    updateAttachments(existingMessage, updatedMessage.attachments);
                } else {
                    console.log("Attachments have not changed");
                }
            }



    
            $('#message-form').submit(function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                $.ajax({
                    url: '/send_private_message',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        if (response.status === 'success') {
                            $('#message-form textarea').val('');
                            $('#message-form input[type="file"]').val('');
                            displayMessage(response.message_data);
                            lastCheck = response.message_data.created_at;
                        } else {
                            alert('Failed to send message: ' + response.message);
                        }
                    }
                });
            });
    
            $(document).on('click', '.delete-btn', function() {
                const messageBox = $(this).closest('.message-box');
                const messageId = messageBox.data('message-id');
                if (confirm('Are you sure you want to delete this message?')) {
                    $.ajax({
                        url: '/delete_private_message',
                        method: 'POST',
                        data: { message_id: messageId },
                        success: function(response) {
                            if (response.status === 'success') {
                                messageBox.closest('.message-container').fadeOut(200, function() {
                                    $(this).remove();
                                });
                            } else {
                                alert('Failed to delete message: ' + response.message);
                            }
                        },
                        error: function() {
                            alert('An error occurred while trying to delete the message.');
                        }
                    });
                }
            });

    
            setInterval(fetchNewMessages, 50);
        });
    </script>
</body>
</html>
