<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/mian.css') }}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discover</title>
</head>
<body>
    {% with messages = get_flashed_messages() %}
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-info flash-message">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let alerts = document.querySelectorAll('.flash-message');
            
            alerts.forEach(alert => {
                setTimeout(() => {
                    alert.classList.add('fade-out');
                    
                    alert.addEventListener('animationend', () => {
                        alert.remove();
                    });
                }, 3000);
            });
        });
    </script>
    <div class="navigation">
        <a href="{{ url_for('profile') }}">profil</a>
        <a href="{{ url_for('main') }}">g≈Ç√≥wna</a>
        <a href="{{ url_for('ai') }}">AI</a>
        <a href="{{ url_for('search') }}">wyszukaj urzytkownika</a>
        <a href="{{ url_for('private') }}">prywatne</a>
        <a href="{{ url_for('logout') }}">Wyloguj siƒô</a>
    </div>
    <div class="nawigacja">
        <a href="{{ url_for('main') }}">g≈Ç√≥wna</a>
        <a href="{{ url_for('following') }}">obesrwowane</a>
    </div>
<div class="search-form">
    <form id="search-form" action="{{ url_for('main') }}" method="GET">
        <input type="text" name="search_query" placeholder="Wyszukaj..." value="{{ request.args.get('search_query', '') }}">
        <label>
            <input type="radio" name="search_type" value="post_text" {% if request.args.get('search_type') != 'tag' %}checked{% endif %}> Wyszukaj w tre≈õci post√≥w
        </label>
        <label>
            <input type="radio" name="search_type" value="tag" {% if request.args.get('search_type') == 'tag' %}checked{% endif %}> Wyszukaj po tagu
        </label>
        <button type="submit">Szukaj</button>
    </form>
</div>
    <h1 class="welcome-header">Witaj, {{ user.nick }}!</h1>

    <form id="postForm" enctype="multipart/form-data">
        <h2 class="wysy≈Çanie">WY≈öLIJ POST</h2>
        <textarea id="messageInput" name="messageInput" rows="5" required></textarea>
        <div id="drop-zone" class="drop-zone">
            <p>PrzeciƒÖgnij i upu≈õƒá pliki tutaj lub kliknij, aby wybraƒá</p>
            <input type="file" id="fileInput" name="fileInput" hidden multiple>
        </div>
        <label>
            <input type="checkbox" name="is_private" hidden>
            <input type="checkbox" name="no_comments"> brak komentarzy
            <input type="text" id="tagInput" name="tagInput" placeholder="Enter tags (comma-separated)">
        </label>
        <div id="attachments-preview"></div>
        <button type="submit">Send</button>
    </form>
    <div id="overlaymessages" style="display: none;">
        <div id="editMessageForm" style="display: none;">
            <textarea id="editMessageContent"></textarea>
            <div id="existingMessageAttachments"></div>
            <div id="edit-drop-zone" class="drop-zone">
                <p>PrzeciƒÖgnij i upu≈õƒá pliki tutaj lub kliknij, aby wybraƒá</p>
                <input type="file" id="editMessageFiles" multiple style="display: none;">
            </div>
            <div id="editMessageAttachmentsPreview"></div>
            <label>
                <input type="text" id="edittagInput" name="edittagInput" placeholder="Enter tags (comma-separated)">
            </label>
            <button id="saveMessageEdit">Save</button>
            <button id="cancelMessageEdit">Cancel</button>
            
        </div>
    </div>

    <div id="posts">
        <h1 class="welcome-header">POSTY</h1>
        {% for post in posts %}
            <div class="post-clickable post" data-post-id="{{ post.id }}">
                <a href="{{ url_for('user_profile', user_id=post.author.id) }}">
                <div class="post-header">
                    {% if post.author.zdjecie_wskaznik == "basics/profile.png" %}
                        <img src="{{ url_for('static', filename='basics/profile.png') }}" alt="Default profile picture" class="profile-picture">
                    {% elif post.author.zdjecie_wskaznik %}
                        <img src="{{ url_for('static', filename='uploads/' + post.author.zdjecie_wskaznik) }}" alt="{{ post.author.nick }}'s profile picture" class="profile-picture">
                    {% endif %}
                    <p class="author-name">{{ post.author.nick }}</p>
                </a>
                    {% if post.author.nick == current_user.nick or current_user.has_role('admin'):%}
                        <div class="options-public-post">
                            <button class="remove-post" data-post-id="{{ post.id }}" value="USUN">USUN</button>
                            {% if post.author.nick == current_user.nick%}
                            <button class="edit-post" data-post-id="{{ post.id }}" value="ZMIEN">ZMIEN</button>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
                <p class="post-content">{{ post.text }}</p>
                <div class="attachments">
                    {% for attachment in post.post_attachments %}
                        {% if attachment.file_type.startswith('image/') %}
                            {% set image_path = 'uploads/' + attachment.file_name %}
                            <img src="{{ url_for('static', filename=image_path) }}" alt="{{ attachment.file_name }}" data-id="{{ attachment.id }}">
                        {% elif attachment.file_type.startswith('video/') %}
                            {% set video_path = 'uploads/' + attachment.file_name %}
                            <video controls data-id="{{ attachment.id }}">
                                <source src="{{ url_for('static', filename=video_path) }}" type="{{ attachment.file_type }}">
                            </video>
                        {% elif attachment.file_type.startswith('audio/') %}
                            {% set audio_path = 'uploads/' + attachment.file_name %}
                            <audio controls data-id="{{ attachment.id }}">
                                <source src="{{ url_for('static', filename=audio_path) }}" type="{{ attachment.file_type }}">
                            </audio>
                        {% else %}
                            <p>
                                <a data-id="{{ attachment.id }}" href="{{ url_for('download_file', attachment_id=attachment.id) }}">Pobierz {{ attachment.original_filename }}</a> 
                            </p>
                        {% endif %}
                    {% endfor %}
                </div>
                <div class="tags">
                    <p>Tagi:</p>
                    {% for tag in post.get_tags() %}
                        <p class="tag">{{ tag }}</p>
                    {% endfor %}
                </div>
                <div class="reactions">
                    {% for reaction_type, emoji in [
                        ('like', 'üëç'), 
                        ('love', '‚ù§Ô∏è'), 
                        ('haha', 'üòÇ'), 
                        ('wow', 'üòÆ'), 
                        ('sad', 'üò¢')
                    ] %}
                        <button class="reaction-btn" data-post-id="{{ post.id }}" data-reaction-type="{{ reaction_type }}">
                            {{ emoji }} <span class="reaction-count" id="count-{{ post.id }}-{{ reaction_type }}">0</span>
                        </button>
                    {% endfor %}
                </div>
                <div class="edited_post_comment">
                    {% if post.is_edited %}
                    Edytowany o {{ post.edited_at | add_hours(1)  }}
                    {% endif %}
                </div>
                <div id="overlaymessages" style="display: none;">
                    <div id="editMessageForm" style="display: none;">
                        <textarea id="editMessageContent"></textarea>
                        <div id="existingMessageAttachments"></div>
                        <div id="edit-drop-zone" class="drop-zone">
                            <p>PrzeciƒÖgnij i upu≈õƒá pliki tutaj lub kliknij, aby wybraƒá</p>
                            <input type="file" id="editMessageFiles" multiple style="display: none;">
                        </div>
                        <div id="editMessageAttachmentsPreview"></div>
                        <label>
                            <input type="text" id="edittagInput" name="edittagInput" placeholder="Enter tags (comma-separated)">
                        </label>
                        <button id="saveMessageEdit">Save</button>
                        <button id="cancelMessageEdit">Cancel</button>
                    </div>
                </div>
                {% if not post.comments_allowed %}
                <button class="toggle-comments" data-post-id="{{ post.id }}">Komentarze ({{ post.post_comments|length }})</button>
                {% else %}
                <p style="color: red;">Komentarze sƒÖ niedozwolone</p>
                {% endif %}
                <div class="comments" id="comments-{{ post.id }}" style="display: none;">
                    <form class="comment-form" data-post-id="{{ post.id }}">
                        <textarea name="comment-text" required></textarea>
                        <button type="submit">Dodaj komentarz</button>
                    </form>
                    {% for comment in post.post_comments %}
                    <div class="comment">
                        <div class="comment-header">
                            {% if comment.user.zdjecie_wskaznik == "basics/profile.png" %}
                            <img src="{{ url_for('static', filename='basics/profile.png') }}" alt="Default profile picture" class="profile-picture">
                            {% else %}
                            <img src="{{ url_for('static', filename='uploads/' + comment.user.zdjecie_wskaznik) }}" alt="{{ comment.user.nick }}'s profile picture" class="profile-picture">
                            {% endif %}
                            <p class="author-name">{{ comment.user.nick }}</p>
                        </div>
                        <p class="comment-content">{{ comment.text }}</p>
                        {% if current_user.is_authenticated and 
                            (current_user.id == comment.user_id or 
                             current_user.id == post.author.id or 
                             current_user.has_role("admin")) %}
                        <button class="delete-comment" data-comment-id="{{ comment.id }}" onclick="deleteComment(event)">USUN</button>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        {% endfor %}


    


    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const postForm = document.getElementById('postForm');
            const messageInput = document.getElementById('messageInput');
            const fileInput = document.getElementById('fileInput');
            const attachmentsPreview = document.getElementById('attachments-preview');
            const dropZone = document.getElementById('drop-zone');
            const tagInput = document.getElementById('tagInput');

            dropZone.addEventListener('click', function(e) {
                    fileInput.click();
            });
    
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });
    
            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, highlight, false);
            });
    
            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, unhighlight, false);
            });
    
            dropZone.addEventListener('drop', handleDrop, false);


            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
    
            function highlight(e) {
                dropZone.classList.add('highlight');
            }
    
            function unhighlight(e) {
                dropZone.classList.remove('highlight');
            }
    
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                handleFiles(files);
            }
    
            function handleFiles(newFiles) {
                const dt = new DataTransfer();
                
                for (let file of fileInput.files) {
                    dt.items.add(file);
                }
                
                for (let file of newFiles) {
                    dt.items.add(file);
                }
                
                fileInput.files = dt.files;
                updateAttachmentPreviews();
            }
    
            fileInput.addEventListener('change', function(e) {
                updateAttachmentPreviews();
            });
    
            function updateAttachmentPreviews() {
                const currentFiles = Array.from(fileInput.files);
                const currentPreviews = Array.from(attachmentsPreview.children);
                
                currentPreviews.forEach(preview => {
                    const fileName = preview.dataset.fileName;
                    if (!currentFiles.some(file => file.name === fileName)) {
                        preview.remove();
                    }
                });
                
                for (let file of currentFiles) {
                    if (!currentPreviews.some(preview => preview.dataset.fileName === file.name)) {
                        const attachmentElement = createAttachmentElement({
                            type: file.type.startsWith('image/') ? 'img' : 
                                  file.type.startsWith('video/') ? 'video' :
                                  file.type.startsWith('audio/') ? 'audio' : 'file',
                            src: URL.createObjectURL(file),
                            file: file
                        });
                        attachmentElement.dataset.fileName = file.name;
                        attachmentsPreview.appendChild(attachmentElement);
                    }
                }
            }
        
            function createAttachmentElement(attachment) {
                const attachmentDiv = document.createElement('div');
                attachmentDiv.className = 'attachment-preview';
                attachmentDiv.style.width = '100px';
                attachmentDiv.style.height = '100px';
                attachmentDiv.style.display = 'inline-block';
                attachmentDiv.style.margin = '5px';
                attachmentDiv.style.position = 'relative';
                attachmentDiv.style.border = '1px solid #ccc';
                attachmentDiv.style.borderRadius = '5px';
                attachmentDiv.style.overflow = 'hidden';
                attachmentDiv.dataset.fileName = attachment.file.name;
        
                let contentElement;
                if (attachment.type === 'img') {
                    contentElement = document.createElement('img');
                    contentElement.src = attachment.src;
                    contentElement.style.width = '100%';
                    contentElement.style.height = '100%';
                    contentElement.style.objectFit = 'cover';
                } else {
                    contentElement = document.createElement('div');
                    contentElement.style.fontSize = '40px';
                    contentElement.style.backgroundColor = 'transparent';
                    contentElement.style.display = 'flex';
                    contentElement.style.justifyContent = 'center';
                    contentElement.style.alignItems = 'center';
                    contentElement.style.width = '100%';
                    contentElement.style.height = '100%';
        
                    if (attachment.type === 'video') {
                        contentElement.textContent = 'üé•';
                    } else if (attachment.type === 'audio') {
                        contentElement.textContent = 'üéµ';
                    } else {
                        contentElement.textContent = 'üìé';
                    }
                }
                attachmentDiv.appendChild(contentElement);
        
                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'X';
                deleteButton.style.position = 'absolute';
                deleteButton.style.top = '0';
                deleteButton.style.right = '0';
                deleteButton.style.background = 'red';
                deleteButton.style.color = 'white';
                deleteButton.style.border = 'none';
                deleteButton.style.cursor = 'pointer';
                deleteButton.onclick = (e) => {
                    e.preventDefault();
                    const dt = new DataTransfer();
                    const files = fileInput.files;
                    for (let i = 0; i < files.length; i++) {
                        if (files[i] !== attachment.file) {
                            dt.items.add(files[i]);
                        }
                    }
                    fileInput.files = dt.files;
                    attachmentDiv.remove();
                };
                attachmentDiv.appendChild(deleteButton);
        
                return attachmentDiv;
            }

            let currentEditMessageId = null;

            postForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(postForm);
                const messageInput = document.getElementById('messageInput');
                const text = messageInput.value.trim();
                sendPost(formData);
            });

            function sendPost(formData) {
    
                
                
                fetch('/public_post', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === "OK") {
                        fileInput.value = '';
                        messageInput.value = '';
                        attachmentsPreview.innerHTML = '';
                        tagInput.value = '';
                    } else {
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('WystƒÖpi≈Ç b≈ÇƒÖd podczas dodawania posta.');
                });
            }
        });
        

    </script>
    <script>
        function deletePost(postId) {
            if (confirm('Czy na pewno chcesz usunƒÖƒá ten post?')) {
                fetch(`/delete_post/${postId}`, {
                    method: 'DELETE',
                })
                .then(response => response.json())
                .then(data => {
                    if(data.status === "OK") {
                        document.querySelector(`.post[data-post-id="${postId}"]`).remove();
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('WystƒÖpi≈Ç b≈ÇƒÖd podczas usuwania posta.');
                });
            }
        }
        document.addEventListener('DOMContentLoaded', function() {
            const removePostButtons = document.querySelectorAll('.remove-post');
        
            removePostButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const postId = this.dataset.postId;
                    deletePost(postId);
                });
            });
        });
    </script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const overlaymessages = document.getElementById('overlaymessages');
            const editMessageForm = document.getElementById('editMessageForm');
            const editMessageContent = document.getElementById('editMessageContent');
            const existingMessageAttachments = document.getElementById('existingMessageAttachments');
            const editDropZone = document.getElementById('edit-drop-zone');
            const editMessageFiles = document.getElementById('editMessageFiles');
            const editMessageAttachmentsPreview = document.getElementById('editMessageAttachmentsPreview');
            const saveMessageEdit = document.getElementById('saveMessageEdit');
            const cancelMessageEdit = document.getElementById('cancelMessageEdit');
            const tagInput = document.getElementById('edittagInput');
        

            console.log('DOM elements:', {
                overlaymessages,
                editMessageForm,
                editMessageContent,
                existingMessageAttachments,
                editDropZone,
                editMessageFiles,
                editMessageAttachmentsPreview,
                saveMessageEdit,
                cancelMessageEdit
            });


            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
        
            function highlight(e) {
                editDropZone.classList.add('highlight');
            }
        
            function unhighlight(e) {
                editDropZone.classList.remove('highlight');
            }
        
            function handleEditDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                handleEditFiles(files);
            }
        
            function handleEditFiles(files) {
                [...files].forEach(file => {
                    if ([...editMessageFiles.files].every(f => f.name !== file.name)) {
                        const dataTransfer = new DataTransfer();
                        [...editMessageFiles.files].forEach(f => dataTransfer.items.add(f));
                        dataTransfer.items.add(file);
                        editMessageFiles.files = dataTransfer.files;
                        const attachment = {
                            type: file.type.startsWith('image/') ? 'img' : 
                                  file.type.startsWith('video/') ? 'video' :
                                  file.type.startsWith('audio/') ? 'audio' : 'file',
                            src: URL.createObjectURL(file),
                            file: file
                        };
                        const attachmentElement = createAttachmentElement(attachment);
                        editMessageAttachmentsPreview.appendChild(attachmentElement);
                    }
                });
            }
            function uploadEditFile(file) {
                handleEditFiles([file]);
            }
        
            editDropZone.addEventListener('click', function(e) {
                    editMessageFiles.click();
            });
        
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                editDropZone.addEventListener(eventName, preventDefaults, false);
            });
        
            ['dragenter', 'dragover'].forEach(eventName => {
                editDropZone.addEventListener(eventName, highlight, false);
            });
        
            ['dragleave', 'drop'].forEach(eventName => {
                editDropZone.addEventListener(eventName, unhighlight, false);
            });
        
            editDropZone.addEventListener('drop', handleEditDrop, false);
        
            editMessageFiles.addEventListener('change', function(e) {
                handleEditFiles(this.files);
            });
        

            let currentEditMessageId = null;
            let currentAttachments = [];
            let currentPostId = null;
            let attachmentsToDelete = [];

    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('edit-post')) {
            const postElement = e.target.closest('.post');
            currentPostId = postElement.dataset.postId;
            
            const contentElement = postElement.querySelector('.post-content');
            const content = contentElement.textContent;
            const attachments = Array.from(postElement.querySelectorAll('[data-id]')).map(el => ({
                id: el.dataset.id,
                type: el.tagName.toLowerCase(),
                src: el.src || el.querySelector('source')?.src
            }));
            console.log("attachmenty wykryte " + attachments);

            const tags = Array.from(postElement.querySelectorAll('.tag')).map(tag => tag.textContent).join(', ');
            
            showEditForm(currentPostId, content, attachments, tags);
        }
    });

    function showEditForm(postId, content, attachments, tags) {
        currentPostId = postId;
        editMessageContent.value = content;
        tagInput.value = tags;
        existingMessageAttachments.innerHTML = '';
        editMessageAttachmentsPreview.innerHTML = '';
        attachmentsToDelete = [];
    
        attachments.forEach(attachment => {
            const attachmentElement = createAttachmentElement({
                id: attachment.id,
                type: attachment.type,
                src: attachment.src
            });
            existingMessageAttachments.appendChild(attachmentElement);
        });
    
        const postBox = document.querySelector(`.post[data-post-id="${postId}"]`);
        const rect = postBox.getBoundingClientRect();
    
        overlaymessages.style.display = 'block';
        overlaymessages.style.position = 'fixed';
        overlaymessages.style.top = `${rect.top}px`;
        overlaymessages.style.left = `${rect.left}px`;
        overlaymessages.style.width = `${rect.width}px`;
        overlaymessages.style.height = `${rect.height}px`;
        overlaymessages.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
        overlaymessages.style.zIndex = '1000';
    
        editMessageForm.style.display = 'block';
        editMessageForm.style.position = 'fixed';
        editMessageForm.style.top = `${rect.top}px`;
        editMessageForm.style.left = `${rect.left}px`;
        editMessageForm.style.width = `${rect.width}px`;
        editMessageForm.style.minHeight = `${rect.height}px`;
        editMessageForm.style.maxWidth = 'none';
        editMessageForm.style.backgroundColor = 'transparent';
        editMessageForm.style.padding = '20px';
        editMessageForm.style.boxSizing = 'border-box';
        editMessageForm.style.zIndex = '1001';
        editMessageForm.style.overflow = 'auto';
        editMessageForm.style.height = 'auto';
        
    }
    
    function hideEditForm() {
        overlaymessages.style.display = 'none';
        editMessageForm.style.display = 'none';
        currentPostId = null;
        editMessageContent.value = '';
        tagInput.value = '';
        existingMessageAttachments.innerHTML = '';
        editMessageAttachmentsPreview.innerHTML = '';
        attachmentsToDelete = [];
        editMessageFiles.value = '';
    }


            function createAttachmentElement(attachment) {
                console.log('Attachment ' + attachment.id );
                const attachmentDiv = document.createElement('div');
                attachmentDiv.className = 'attachment-preview';
                attachmentDiv.style.width = '100px';
                attachmentDiv.style.height = '100px';
                attachmentDiv.style.display = 'inline-block';
                attachmentDiv.style.margin = '5px';
                attachmentDiv.style.position = 'relative';
                attachmentDiv.style.border = '1px solid #ccc';
                attachmentDiv.style.borderRadius = '5px';
                attachmentDiv.style.overflow = 'hidden';


                let contentElement;
                if (attachment.type === 'img') {
                    contentElement = document.createElement('img');
                    contentElement.src = attachment.src;
                    contentElement.style.width = '100%';
                    contentElement.style.height = '100%';
                    contentElement.style.objectFit = 'cover';
                } else {
                    const link = document.createElement('a');
                    link.href = attachment.src;
                    link.target = '_blank';

                    contentElement = document.createElement('div');
                    contentElement.style.fontSize = '40px';
                    contentElement.style.backgroundColor = 'transparent';
                    contentElement.style.display = 'flex';
                    contentElement.style.justifyContent = 'center';
                    contentElement.style.alignItems = 'center';
                    contentElement.style.width = '100%';
                    contentElement.style.height = '100%';

                    if (attachment.type === 'video') {
                        contentElement.textContent = 'üé•';
                    } else if (attachment.type === 'audio') {
                        contentElement.textContent = 'üéµ';
                    } else {
                        contentElement.textContent = 'üìé';
                    }

                    link.appendChild(contentElement);
                    contentElement = link;
                }

                attachmentDiv.appendChild(contentElement);

                if (attachment.id) {
                    contentElement.dataset.id = attachment.id;
                } 
                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'X';
                deleteButton.style.position = 'absolute';
                deleteButton.style.top = '0';
                deleteButton.style.right = '0';
                deleteButton.style.background = 'red';
                deleteButton.style.color = 'white';
                deleteButton.style.border = 'none';
                deleteButton.style.cursor = 'pointer';
                deleteButton.onclick = (e) => {
                    e.preventDefault();
                    if (attachment.id) {
                        attachmentsToDelete.push(attachment.id);
                    } else {
                        const dt = new DataTransfer();
                        const files = editMessageFiles.files;
                        for (let i = 0; i < files.length; i++) {
                            if (files[i] !== attachment.file) {
                                dt.items.add(files[i]);
                            }
                        }
                        editMessageFiles.files = dt.files;
                    }
                    attachmentDiv.remove();
                };
                attachmentDiv.appendChild(deleteButton);
                return attachmentDiv;
            }


                
            saveMessageEdit.addEventListener('click', async () => {
                const formData = new FormData();
                formData.append('text', editMessageContent.value);
                formData.append('tags', tagInput.value);
                Array.from(existingMessageAttachments.children)
                // Collect existing attachments that should be kept
                const existingAttachments = Array.from(existingMessageAttachments.children)
                    .map(child => {
                        const element = child.querySelector('img, video, audio, a');
                        if (element) {
                            let type, src;
                            if (element.tagName.toLowerCase() === 'a') {
                                type = 'file';
                                src = element.href;
                            } else {
                                type = element.tagName.toLowerCase();
                                src = element.src || element.querySelector('source')?.src;
                            }
                            return {
                                id: element.dataset.id,
                                type: type,
                                src: src
                            };
                        }
                        return null;
                    })
                    .filter(attachment => attachment && !attachmentsToDelete.includes(attachment.id));
                
                // Append existing attachments to keep
                console.log(JSON.stringify(existingAttachments));
                formData.append('attachments', JSON.stringify(existingAttachments));
                
                // Append attachments to delete
                attachmentsToDelete.forEach(id => formData.append('delete_attachments', id));
                
                // Append new attachments
                for (let file of editMessageFiles.files) {
                    formData.append('new_attachments', file);
                }
                console.log("Existing attachments:", Array.from(formData.getAll('existing_attachments[]')));
                console.log("New files:", Array.from(formData.getAll('new_files[]')));
                    
                try {
                    const response = await fetch(`/edit_post/${currentPostId}`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.status === "OK") {
                            //location.reload(); 
                            hideEditForm();
                        } else {
                            console.error('Server response:', result);
                            alert('Error saving changes: ' + (result.message || 'Unknown error'));
                        }
                    } else {
                        const errorText = await response.text();
                        console.error('Server error:', response.status, errorText);
                        alert(`Error saving changes. Status: ${response.status}. Details: ${errorText}`);
                    }
                } catch (error) {
                    console.error('Network error:', error);
                    alert('Network error while saving changes: ' + error.message);
                }
            });
            cancelMessageEdit.addEventListener('click', hideEditForm);
        
            editMessageFiles.addEventListener('change', function(e) {
                editMessageAttachmentsPreview.innerHTML = '';
                for (let file of e.target.files) {
                    const attachmentDiv = createAttachmentElement({
                        type: file.type.startsWith('image/') ? 'img' : 
                              file.type.startsWith('video/') ? 'video' :
                              file.type.startsWith('audio/') ? 'audio' : 'file',
                        src: URL.createObjectURL(file),
                        file: file 
                    });
                    editMessageAttachmentsPreview.appendChild(attachmentDiv);
                }
            });
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const commentForms = document.querySelectorAll('.comment-form');
            
            commentForms.forEach(form => {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const postId = this.getAttribute('data-post-id');
                    const commentText = this.querySelector('textarea[name="comment-text"]').value;
                    
                    fetch(`/add_comment/${postId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `comment-text=${encodeURIComponent(commentText)}`
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === "OK") {
                            const toggleButton = document.querySelector(`.toggle-comments[data-post-id="${postId}"]`);
                            const currentCount = parseInt(toggleButton.textContent.match(/\d+/)[0]);
                            toggleButton.textContent = `Komentarze (${currentCount + 1})`;
                            
                            this.querySelector('textarea[name="comment-text"]').value = '';
                        } else {
                            alert(data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('WystƒÖpi≈Ç b≈ÇƒÖd podczas dodawania komentarza.');
                    });
                });
            });
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const reactionButtons = document.querySelectorAll('.reaction-btn');
        
            reactionButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const postId = this.dataset.postId;
                    const reactionType = this.dataset.reactionType;
        
                    fetch(`/add_reaction/${postId}/${reactionType}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                    })
                    .then(response => response.json())
                    .then(data => {
                        updateReactionCounts(postId);
                    });
                });
            });
        
            function updateReactionCounts(postId) {
                fetch(`/get_reactions/${postId}`)
                .then(response => response.json())
                .then(data => {
                    for (const [reactionType, count] of Object.entries(data)) {
                        const countElement = document.getElementById(`count-${postId}-${reactionType}`);
                        if (countElement) {
                            countElement.textContent = count;
                        }
                    }
                });
            }
        
            document.querySelectorAll('.post').forEach(post => {
                const postId = post.querySelector('.reaction-btn').dataset.postId;
                updateReactionCounts(postId);
            });
        });
        </script>
<script src="{{ url_for('static', filename='js/post-przycisk.js') }}"></script>
<script>

document.querySelectorAll('.comments').forEach(container => {
    container.addEventListener('click', function(event) {
        if (event.target.classList.contains('delete-comment')) {
            event.stopPropagation();
            const commentId = event.target.dataset.commentId;
            
            if (!confirm('Czy na pewno chcesz usunƒÖƒá ten komentarz?')) return;

            fetch(`/delete_comment/${commentId}`, {
                method: 'DELETE',
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const commentElement = event.target.closest('.comment');
                    commentElement.remove();
                    
                    const postId = commentElement.closest('[id^="comments-"]').id.split('-')[1];
                    const toggleButton = document.querySelector(`button[data-post-id="${postId}"]`);
                    const count = document.querySelectorAll(`#comments-${postId} .comment`).length;
                    if (toggleButton) {
                        toggleButton.textContent = `Komentarze (${count})`;
                    }
                }
            })
            .catch(error => console.error('Error:', error));
        }
    });
});
    document.addEventListener('DOMContentLoaded', function() {
        const toggleButtons = document.querySelectorAll('.toggle-comments');
    
        toggleButtons.forEach(button => {
            button.addEventListener('click', function(event) {
                event.stopPropagation();
                const postId = this.dataset.postId;
                const commentsDiv = document.getElementById(`comments-${postId}`);
    
                if (commentsDiv.style.display === 'none') {
                    commentsDiv.style.display = 'block';
                    this.textContent = `Ukryj komentarze (${commentsDiv.querySelectorAll('.comment').length})`;
                } else {
                    commentsDiv.style.display = 'none';
                    this.textContent = `Komentarze (${commentsDiv.querySelectorAll('.comment').length})`;
                }
            });
        });
    });
</script>
<script src="{{ url_for('static', filename='js/search.js') }}">
</script>
<script>
    const CHECK_INTERVAL = 1000; 
    let previousPostsData = null;
    
    const deepCompare = (a, b) => JSON.stringify(a) === JSON.stringify(b);
    
    const findArrayDifferences = (oldArr, newArr, key) => ({
        added: newArr.filter(n => !oldArr.some(o => o[key] === n[key])),
        removed: oldArr.filter(o => !newArr.some(n => n[key] === o[key])),
        changed: newArr.filter(n => {
            const oldItem = oldArr.find(o => o[key] === n[key]);
            return oldItem && !deepCompare(n, oldItem);
        })
    });
    
    const updateElements = {
        reactions(postId, reactions) {
            const allReactionTypes = ['like', 'love', 'haha', 'wow', 'sad'];
            allReactionTypes.forEach(type => {
                const element = document.querySelector(`#count-${postId}-${type}`);
                if (element) element.textContent = '0';
            });
        
            reactions.forEach(([type, count]) => {
                const element = document.querySelector(`#count-${postId}-${type}`);
                if (element) element.textContent = count;
            });
        },
    
        comments(postElement, newComments) {
            const container = postElement.querySelector('.comments');
            if (!container) return;
    
            const btn = postElement.querySelector('.toggle-comments');
            if (btn) btn.textContent = `Komentarze (${newComments.length})`;
    
            const existingComments = [...container.querySelectorAll('.comment')];
            const newCommentIds = newComments.map(c => c.id.toString());
    
            existingComments.forEach(comment => {
                if (!newCommentIds.includes(comment.dataset.commentId)) comment.remove();
            });
    
            newComments.forEach(comment => {
                let element = container.querySelector(`[data-comment-id="${comment.id}"]`);
                
                if (!element) {
                    element = this.createComment(comment);
                    container.appendChild(element);
                } else {
                    this.updateComment(element, comment);
                }
            });
        },
    
        createComment(comment) {
            const div = document.createElement('div');
            div.className = 'comment';
            div.dataset.commentId = comment.id;
            div.innerHTML = `
                <div class="comment-header">
                    <img src="${comment.author.zdjecie_wskaznik === "basics/profile.png" 
                        ? "/static/basics/profile.png" 
                        : "/static/uploads/" + comment.author.zdjecie_wskaznik}"
                        class="profile-picture">
                    <p class="author-name">${comment.author.nick}</p>
                </div>
                <p class="comment-content">${comment.text}</p>
                ${comment.is_edited ? 
                    `<small>Edytowano: ${new Date(comment.edited_at).toLocaleString()}</small>` : ''}
                ${(currentUser.id == comment.author.id || currentUser.roles.includes('admin')) ?
                    `<button class="delete-comment" data-comment-id="${comment.id}">USU≈É</button>` : ''}
            `;
            return div;
        },
    
        updateComment(element, comment) {
            const content = element.querySelector('.comment-content');
            const edited = element.querySelector('small');
            const authorName = element.querySelector('.author-name');
            const img = element.querySelector('img');
    
            if (content.textContent !== comment.text) {
                content.textContent = comment.text;
            }
    
            if (comment.is_edited) {
                if (!edited) {
                    const small = document.createElement('small');
                    small.textContent = `Edytowano: ${new Date(comment.edited_at).toLocaleString()}`;
                    element.appendChild(small);
                }
            } else if (edited) {
                edited.remove();
            }
    
            if (authorName.textContent !== comment.author.nick) {
                authorName.textContent = comment.author.nick;
            }
    
            const newSrc = comment.author.zdjecie_wskaznik === "basics/profile.png" 
                ? "/static/basics/profile.png" 
                : "/static/uploads/" + comment.author.zdjecie_wskaznik;
            if (img.src !== newSrc) img.src = newSrc;
        },
    
        attachments(postElement, newAttachments) {
            const container = postElement.querySelector('.attachments');
            if (!container) return;
    
            const existing = [...container.children];
            const newIds = newAttachments.map(a => a.id.toString());
    
            existing.forEach(el => {
                if (!newIds.includes(el.dataset.id)) el.remove();
            });
    
            newAttachments.forEach(att => {
                if (!container.querySelector(`[data-id="${att.id}"]`)) {
                    container.appendChild(this.createAttachment(att));
                }
            });
        },
    
        createAttachment(att) {
            const div = document.createElement('div');
            div.dataset.id = att.id;
            
            if (att.file_type.startsWith('image/')) {
                div.innerHTML = `<img src="/static/uploads/${att.file_name}" alt="${att.original_filename}">`;
            } else if (att.file_type.startsWith('audio/')){
                div.innerHTML = `
                    <audio controls>
                        <source src="/static/uploads/${att.file_name}" type="${att.file_type}">
                    </audio>
                `;
            }else if (att.file_type.startsWith('video/')) {
                div.innerHTML = `
                    <video controls>
                        <source src="/static/uploads/${att.file_name}"  type="${att.file_type}">
                    </video>
                `;
            } else {
                div.innerHTML = `
                    <a href="/download_file/${att.id}">
                        Pobierz ${att.original_filename}
                    </a>
                `;
            }
            return div;
        },
    
        tags(postElement, newTags) {
            const container = postElement.querySelector('.tags');
            if (!container) return;
    
            const existing = [...container.querySelectorAll('.tag')];
            const newTagNames = newTags.map(t => t.toLowerCase());
    
            existing.forEach(tag => {
                if (!newTagNames.includes(tag.textContent.toLowerCase())) tag.remove();
            });
    
            newTagNames.forEach(name => {
                if (!existing.some(t => t.textContent.toLowerCase() === name)) {
                    const p = document.createElement('p');
                    p.className = 'tag';
                    p.textContent = name;
                    container.appendChild(p);
                }
            });
        }
    };
    
    const checkForChanges = async () => {
        try {
            const response = await fetch('/get_all_post_detailed');
            if (!response.ok) throw new Error(`B≈ÇƒÖd HTTP: ${response.status}`);
            const newPosts = await response.json();
    
            if (!previousPostsData) {
                previousPostsData = newPosts;
                return;
            }
    
            const diff = findArrayDifferences(previousPostsData, newPosts, 'id');
    
            diff.removed.forEach(post => {
                document.querySelector(`.post[data-post-id="${post.id}"]`)?.remove();
            });
    
            if (diff.added.length > 0) {
                window.location.reload(); 
                return;
            }
    
            diff.changed.forEach(updatedPost => {
                const oldPost = previousPostsData.find(p => p.id === updatedPost.id);
                const postElement = document.querySelector(`.post[data-post-id="${updatedPost.id}"]`);
                if (!postElement || !oldPost) return;
    
                if (updatedPost.text !== oldPost.text) {
                    postElement.querySelector('.post-content').textContent = updatedPost.text;
                }
    
                if (!deepCompare(updatedPost.author, oldPost.author)) {
                    postElement.querySelectorAll('.author-name').forEach(el => {
                        el.textContent = updatedPost.author.nick;
                    });
                    postElement.querySelectorAll('.profile-picture').forEach(img => {
                        img.src = updatedPost.author.zdjecie_wskaznik === "basics/profile.png" 
                            ? "/static/basics/profile.png" 
                            : "/static/uploads/" + updatedPost.author.zdjecie_wskaznik;
                    });
                }
    
                updateElements.reactions(updatedPost.id, Object.entries(
                    updatedPost.reactions.reduce((acc, r) => {
                        acc[r.reaction_type] = (acc[r.reaction_type] || 0) + 1;
                        return acc;
                    }, {})
                ));
                
                updateElements.comments(postElement, updatedPost.comments);
                updateElements.attachments(postElement, updatedPost.attachments);
                updateElements.tags(postElement, updatedPost.tags);
            });
    
            previousPostsData = newPosts;
        } catch (error) {
            console.error('B≈ÇƒÖd synchronizacji:', error);
        }
    };
    
    document.addEventListener('DOMContentLoaded', () => {
        window.currentUser = {
            id: "{{ current_user.id }}",
            roles: {{ current_user.roles | map(attribute='name') | list | tojson }}
        };
    
        checkForChanges();
        setInterval(checkForChanges, CHECK_INTERVAL);
        
        
        
    });
    </script>

</body>
</html> 